name: Build iOS Jailbreak Tweak

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Theos
      run: |
        export THEOS=/opt/theos
        sudo mkdir -p $THEOS
        sudo git clone --recursive https://github.com/theos/theos.git $THEOS
        echo "THEOS=$THEOS" >> $GITHUB_ENV
        echo "PATH=$THEOS/bin:$PATH" >> $GITHUB_ENV
        
        # 安装 ldid（用于签名）
        sudo mkdir -p $THEOS/bin
        
        # 方法1: 尝试使用 Homebrew 安装
        if command -v brew &> /dev/null; then
          if ! command -v ldid &> /dev/null; then
            brew install ldid 2>&1 || echo "Homebrew installation failed"
          fi
          # 如果 Homebrew 安装成功，创建符号链接或复制
          if command -v ldid &> /dev/null; then
            LDidPath=$(which ldid)
            echo "Found ldid at: $LDidPath"
            sudo ln -sf "$LDidPath" $THEOS/bin/ldid 2>/dev/null || \
            sudo cp "$LDidPath" $THEOS/bin/ldid
            echo "ldid linked/copied to $THEOS/bin/ldid"
          fi
        fi
        
        # 方法2: 如果还没有 ldid，尝试直接下载（允许失败）
        if [ ! -f "$THEOS/bin/ldid" ] || ! $THEOS/bin/ldid -v &> /dev/null; then
          echo "Attempting to download ldid..."
          # 使用 || true 确保即使下载失败也不中断脚本
          curl -L -f "https://github.com/ProcursusTeam/ldid/releases/latest/download/ldid" -o /tmp/ldid 2>&1 || true
          
          # 检查下载的文件
          if [ -f /tmp/ldid ]; then
            file /tmp/ldid
            # 检查是否是二进制文件
            if file /tmp/ldid | grep -q "Mach-O\|executable"; then
              sudo mv /tmp/ldid $THEOS/bin/ldid
              sudo chmod +x $THEOS/bin/ldid
              echo "ldid downloaded and installed"
            else
              echo "Downloaded file is not a valid binary"
              rm -f /tmp/ldid
            fi
          else
            echo "Download failed, but continuing..."
          fi
        fi
        
        # 验证安装
        if [ -f "$THEOS/bin/ldid" ] && $THEOS/bin/ldid -v &> /dev/null; then
          echo "✓ ldid installed successfully:"
          $THEOS/bin/ldid -v
        else
          echo "⚠ Warning: ldid not found, but continuing build..."
          echo "Signing step may fail, but compilation will continue"
        fi
        
        # 设置 iOS SDK（使用 Xcode 自带的 SDK）
        SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
        if [ -d "$SDK_PATH" ]; then
          sudo mkdir -p $THEOS/sdks
          sudo cp -r "$SDK_PATH" $THEOS/sdks/iPhoneOS.sdk
          echo "iOS SDK installed: $SDK_PATH"
        fi
    
    - name: Build tweak
      run: |
        export THEOS=/opt/theos
        export PATH=$THEOS/bin:$PATH
        
        # 显示环境信息
        echo "THEOS: $THEOS"
        echo "PATH: $PATH"
        which ldid || echo "ldid not found"
        
        # 编译
        make clean
        make package FINALPACKAGE=1
    
    - name: Check build results
      run: |
        ls -la
        ls -la packages/ 2>/dev/null || echo "Packages directory not found"
        find . -name "*.deb" -type f
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: bossPlugin-deb
        path: |
          packages/*.deb
          *.deb
        if-no-files-found: warn
